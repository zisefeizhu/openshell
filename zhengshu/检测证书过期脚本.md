# æ£€æµ‹è¯ä¹¦è¿‡æœŸè„šæœ¬

### å‰æ

æ€»æ˜¯åçŸ¥åè§‰ï¼Œæ€»æ˜¯åçŸ¥åè§‰ã€‚ç›®å‰çš„ç°çŠ¶æ˜¯ä¸è®ºå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Œéƒ½æ— æ³•è¿›è¡Œæå‰é¢„è­¦å’Œåœ¨å®¢æˆ·æœªçŸ¥å‰ä»‹å…¥å¤„ç†ã€‚æ—©ä¸Šå¶ç„¶å’Œå­¦æ­¦äº¤æµä¸­çªå‘çµæ„Ÿï¼Œå†™ä¸‹æ­¤è„šæœ¬ï¼Œè¯•å›¾ä»¥æ­¤ä¸ºå¼€å§‹è¿›è¡Œæå‰çš„é¢„è­¦ã€‚

ä»ç”Ÿäº§k8sé›†ç¾¤æ‹¿åˆ°realibox.cnçš„è¯ä¹¦ï¼Œåœ¨é¢„å‘ç¯å¢ƒåšdaemonæ¡ˆä¾‹ã€‚

#### daemonæ¡ˆä¾‹

```
# pwd
/yufa/zhengshu/test
ll
total 32
-rw-r--r--  1 root  wheel   465B  9  9 09:50 test-ingress.yaml
-rw-r--r--  1 root  wheel   711B  9  9 09:47 test.yaml
-rw-r--r--  1 root  wheel   3.5K  9  9 09:24 tls.crt
-rw-r--r--  1 root  wheel   1.6K  9  9 09:25 tls.key
# kubectl -n realibox create secret tls realibox-cn --key ./tls.key --cert ./tls.crt
# cat test.yaml
apiVersion: v1
kind: Service
metadata:
  name: tomcat
  namespace: realibox
spec:
  selector:
    app: tomcat
    release: canary
  ports:
  - name: http
    port: 8080
    targetPort: 8080
  - name: ajp
    port: 8009
    targetPort: 8009

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tomcat-deploy
  namespace: realibox
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tomcat
      release: canary
  template:
    metadata:
      labels:
        app: tomcat
        release: canary
    spec:
      containers:
      - name: tomcat
        image: tomcat:7-alpine
        ports:
        - name: httpd
          containerPort: 8080
        - name: ajp
          containerPort: 8009

# cat test-ingress.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-tomcat-tls
  namespace: realibox
  annotations:
    kubernets.io/ingress.class: "kong"
spec:
  tls:
  - hosts:
    - "*.realibox.cn"        #ä¸secretè¯ä¹¦çš„åŸŸåéœ€è¦ä¿æŒä¸€è‡´
    secretName: realibox-cn   #secretè¯ä¹¦çš„åç§°
  rules:
  - host: zisefeizhu.realibox.cn
    http:
      paths:
      - path:
        backend:
          serviceName: tomcat
          servicePort: 8080
```

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1143489/1599632290442-9096aab6-cb32-4588-972d-d80b12ab12c5.png?x-oss-process=image%2Fresize%2Cw_1500)

### ç¼–å†™æ£€æµ‹åŸŸåè¿‡æœŸå°è„šæœ¬

è¯ä¸å¤šè¯´ç›´æ¥æ€¼è„šæœ¬

```
# cat check_daemon.sh
#!/bin/bash
source /etc/profile

#å®šä¹‰é‚®ä»¶å‘é€åˆ—è¡¨
maillist=(
  linkun@realibox.com
  #2350835860@qq.com
)

#å‘é€é‚®ä»¶å‡½æ•°
send_mail(){
    SUBJECT="$1åŸŸåå³å°†åˆ°æœŸ"
    if [ $2 -ge 0 ];then
        CONTENT="$1:æ­¤åŸŸåå³å°†åˆ°æœŸï¼Œå‰©ä½™æ—¶é—´å·²ä¸è¶³$2å¤©ï¼Œè¯·åŠæ—¶ç»­æœŸï¼"
        for mail in ${maillist[*]};do
            echo -e ""å½“å‰æ£€æµ‹çš„åŸŸå:" $domain\n "å‰©ä½™å¤©æ•°: " $days\n ${CONTENT} " | mail -s "${SUBJECT}" $mail
        done
    else
        day=$((-$2))
        CONTENT="$1:æ­¤åŸŸåå·²åˆ°æœŸï¼Œå·²è¶…å‡º$dayå¤©ï¼Œè¯·åŠæ—¶ç»­è´¹ï¼"
        for mail in ${maillist[*]};do
            echo -e "${CONTENT}" | mail -s "${SUBJECT}" $mail
        done
    fi
}

#æ£€æµ‹mailså‘½ä»¤æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™å®‰è£…mailåŒ…
is_install_mail()
{
    which mail &> /dev/null
    if [ $? -ne 0 ];then
        yum install -y mail
    fi
}
is_install_mail

#å®šä¹‰éœ€è¦è¢«æ£€æµ‹çš„åŸŸååˆ—è¡¨
domainlist=(
   zisefeizhu.realibox.cn
)

#æ£€æµ‹åŸŸååˆ°æœŸæ—¶é—´å¹¶é€šçŸ¥
for domain in ${domainlist[*]};do
   echo "å½“å‰æ£€æµ‹çš„åŸŸåï¼š" $domain
    #å–å‡ºåŸŸåè¿‡æœŸæ—¶é—´
    end_time=$(echo | timeout 1 openssl s_client -servername $domain -connect $domain:443 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | awk -F '=' '{print $2}' )

    ([ $? -ne 0 ] || [[ $end_time == '' ]]) &&  exit 10
    end_times=`date -d "$end_time" +%s `
    tmp=`date -d today +"%Y-%m-%d %T"`
    current_times=`date -d "$tmp" +"%s"`

    let left_time=$end_times-$current_times
    days=`expr $left_time / 3600`
    echo "å‰©ä½™å°æ—¶: " $days

    #è½¬æ¢æˆæ—¶é—´æˆ³
    end_times=`date -d "$end_time" +%s `
    #ä»¥æ—¶é—´æˆ³çš„å½¢å¼æ˜¾ç¤ºå½“å‰æ—¶é—´
    tmp=`date -d today +"%Y-%m-%d %T"`
    current_times=`date -d "$tmp" +"%s"`
    #åŸŸååˆ°æœŸå‰©ä½™å¤©æ•°
    let left_time=$end_times-$current_times
    days=`expr $left_time / 86400`
    echo "å‰©ä½™å¤©æ•°: " $days
    if [ $days -lt 100 ]; then
         echo "https è¯ä¹¦æœ‰æ•ˆæœŸå°‘äº100å¤©ï¼Œå­˜åœ¨é£é™©"
         send_mail $domain $days
    fi
done
```

### å‘é€é‚®ä»¶è®¾ç½®

#### è·å–ç½‘æ˜“äº‘é‚®ç®±æˆæƒç 

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1143489/1599630384570-f6c28353-d545-465b-970a-1786b6c0e45d.png)

#### é…ç½®å‘é€é‚®ç®±äººä¿¡æ¯

```
å®‰è£…postfix
# yum -y install postfix
# systemctl enable postfix

è®¾ç½®å‘é€é‚®ç®±ä¿¡æ¯
# vim /etc/mail.rc
......
æ–°å¢
set from=13203752291@163.com
set smtp=smtp.163.com
set smtp-auth-user=13203752291@163.com
set smtp-auth-password=ZXUGLZGWRYEMYCSQ
set smtp-auth=login

# systemctl start postfix
# echo "test" |mail -s "tesc message" 2350835860@qq.com  
could not connect: è¿æ¥è¶…æ—¶
"/root/dead.letter" 11/308
. . . message not sent.

è¶…æ—¶åŸå› ï¼šé˜¿é‡Œäº‘æœåŠ¡å™¨å…³é—­äº†25ç«¯å£ï¼Œå‘é€é‚®ä»¶è¿æ¥ä¸ä¸ŠæœåŠ¡å™¨çš„ç¼˜æ•…ï¼Œè€Œä¸”å®˜æ–¹ä¸å…è®¸æ‰“å¼€è¯¥ç«¯å£
```

ç½‘æ˜“163å…è´¹é‚®ç®±ç›¸å…³æœåŠ¡å™¨ä¿¡æ¯ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1143489/1599630670128-fc85f352-3355-475e-b53d-7cbdb77c9253.png)

æ‰€ä»¥é™¤äº†æ¢é‚®ç®±ä¹‹å¤–ï¼ˆç«¯å£ä¸æ˜¯25çš„ï¼Œè¦ä¹ˆæ˜¯å›½å¤–ä¸å¥½ç”³è¯·ï¼Œè¦ä¹ˆæ”¶è´¹ï¼Œæ‘¸æ‘¸å£è¢‹â€¦ï¼‰

ä»¥ç½‘æ˜“163é‚®ç®±ä¸ºä¾‹ï¼Œä½¿ç”¨SSLä¸‹çš„465ç«¯å£

```
è¯·æ±‚æ•°å­—è¯ä¹¦
mkdir -p /root/.certs/
echo -n | openssl s_client -connect smtp.163.com:465 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > ~/.certs/163.crt
certutil -A -n "GeoTrust SSL CA" -t "C,," -d ~/.certs -i ~/.certs/163.crt

ä¿®ç¨¿é‚®ä»¶å‘é€äººè®¾ç½®
# vim /etc/mail.rc
......
æ”¹å¢
set from=13203752291@163.com
set smtp=smtps://smtp.163.com:465
set smtp-auth-user=13203752291@163.com
set smtp-auth-password=ZXUGLZGWRYEMYCSQ
set smtp-auth=login
set ssl-verify=ignore
set nss-config-dir=/root/.certs

é‡å¯æµ‹è¯•
# systemctl restart postfix
# echo "test" |mail -s "title" linkun@realibox.com
```

ç™»é™†é‚®ç®±éªŒè¯

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1143489/1599631401923-d4dfe9a7-4ded-4ad5-8e90-a8e011f49bff.png)

emmmã€‚æ”¶åˆ°æ˜¯æ”¶åˆ°äº†ï¼Œä½†æœ‰ä¸ªæŠ¥é”™

```
è¯ä¹¦ä¸è¢«ä¿¡ä»»ï¼Œä¸”å‘½ä»¤è¡Œå°±æ­¤å¡ä½ï¼Œéœ€è¦æŒ‰é”®æ‰èƒ½å‡ºç°å‘½ä»¤æç¤ºç¬¦
# Error in certificate: Peer's certificate issuer is not recognized.

å¤„ç†æ­¤é—®é¢˜
# cd /root/.certs/
# ll 
æ€»ç”¨é‡ 80
-rw-r--r-- 1 root root  2415 9æœˆ   9 13:31 163.crt
-rw------- 1 root root 65536 9æœˆ   9 13:35 cert8.db
-rw------- 1 root root 16384 9æœˆ   9 13:35 key3.db
-rw------- 1 root root 16384 9æœˆ   9 13:31 secmod.db
# certutil -A -n "GeoTrust SSL CA - G3" -t "Pu,Pu,Pu" -d ./ -i 163.crt
é—®é¢˜è§£å†³
```

### æµ‹è¯•daemonæ¡ˆä¾‹

æ‰§è¡Œè„šæœ¬

```
sh check_daemon.sh
å½“å‰æ£€æµ‹çš„åŸŸåï¼š zisefeizhu.realibox.cn
å‰©ä½™å¤©æ•°:  73
å‰©ä½™å¤©æ•°:  73
https è¯ä¹¦æœ‰æ•ˆæœŸå°‘äº100å¤©ï¼Œå­˜åœ¨é£é™©
```

éªŒè¯

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1143489/1599632570844-728c7fdb-4cb1-40d6-8410-cd0283709748.png?x-oss-process=image%2Fresize%2Cw_1500)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1143489/1599633308472-f6d51430-68be-4225-8c74-5766e91e76b3.png)

ğŸ‘Œï¼

### å®šæ—¶ä»»åŠ¡

```
# cat /etc/crontab
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root

# For details see man 4 crontabs

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed
#Timing execution /root/scripts/check_daemon.sh
0 2  *  *  *  root  sh /root/scripts/check_daemon.sh
```